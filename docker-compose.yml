# Docker Compose for NeoKai Self-Hosting Mode
# Mounts project root for live development with isolated node_modules

services:
  neokai-self:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: neokai-self
    ports:
      - '9983:9983'
    environment:
      - NODE_ENV=production
      - PORT=9983
      - HOST=0.0.0.0
      # Add your API key here or use .env file
      # - ANTHROPIC_API_KEY=sk-ant-...
      # - CLAUDE_CODE_OAUTH_TOKEN=...
    env_file:
      - .env
    volumes:
      # Mount project root for development
      - ./packages:/app/packages
      - ./package.json:/app/package.json

      # Override node_modules with named volumes to avoid conflicts
      - neokai_node_modules:/app/node_modules
      - neokai_cli_node_modules:/app/packages/cli/node_modules
      - neokai_daemon_node_modules:/app/packages/daemon/node_modules
      - neokai_web_node_modules:/app/packages/web/node_modules
      - neokai_shared_node_modules:/app/packages/shared/node_modules

      # Mount workspace (the project itself for self-development)
      - .:/workspace

      # Persist database
      - neokai_self_data:/data

      # Build output cache
      - neokai_web_dist:/app/packages/web/dist
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9983/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  # Named volumes for isolated node_modules
  neokai_node_modules:
  neokai_cli_node_modules:
  neokai_daemon_node_modules:
  neokai_web_node_modules:
  neokai_shared_node_modules:

  # Data persistence
  neokai_self_data:

  # Build cache
  neokai_web_dist:
