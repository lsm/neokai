# E2E Tests - Comprehensive E2E test suite (manual trigger)
#
# This workflow runs 70+ E2E tests in parallel with browser-side coverage.
# Each test runs against an in-process daemon server.
#
# Note: Only browser coverage (web package) is collected during E2E tests.
# Server-side coverage (daemon/shared) is collected by the package-tests workflow.
# Browser coverage: Playwright monocart-reporter collects V8 coverage from browser
#
# For automatic coverage on push/PR, see e2e-quick.yml (quick mode - 11 tests)

name: E2E Matrix

on:
  workflow_dispatch:
    inputs:
      test:
        description: 'Specific test to run (empty for all)'
        required: false
        type: string

env:
  SELECTED_TEST: ${{ inputs.test || '' }}

jobs:
  e2e:
    name: E2E (${{ matrix.test }})
    runs-on: arc-runner-set
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        test:
          - 2-stage-creation
          - auto-scroll-toggle
          - auto-title-generation
          - zzz-character-counter
          - chat-flow-improved
          - chat-flow
          - connection-overlay
          - connection-state
          - context-dropdown
          - context-usage-display
          - context-usage-dropdown-content
          - context-usage-dropdown-close
          - draft-clearing-bug
          - draft-persistence
          - default-model-haiku
          - error-handling
          - file-attachment-ui
          - file-attachment-preview
          - file-attachment-send
          - file-attachment-validation
          - file-operations
          - interrupt-button
          - message-input-layout-and-styling
          - message-input-processing-state
          - message-pagination
          - message-removal
          - message-send-receive
          - model-switcher
          - mobile-layout
          - mobile-input
          - mobile-messages
          - tablet-responsive
          - multi-session-rapid-operations
          - page-refresh-context
          - page-refresh-session-state
          - processing-state
          - recent-sessions-home
          - reconnection-basic
          - reconnection-cycles
          - reconnection-long-period
          - reconnection-order
          - scroll-responsiveness
          - scroll-to-bottom-button
          - archive-behavior
          - archive-edge-cases
          - archive-flow
          - archive-menu-option
          - archive-sidebar-toggle
          - session-export
          - session-info-modal
          - session-list-ordering
          - session-management
          - session-switching-active-state
          - session-switching-subscriptions
          - session-switching-context
          - session-switching-rapid
          - settings-modal-basic
          - settings-modal-authentication
          - settings-modal-global-settings
          - settings-modal-persistence
          - slash-cmd-basic
          - slash-cmd-built-in
          - slash-cmd-edge-cases
          - slash-cmd-navigation
          - slash-cmd-selection
          - mcp-toggle-edge-cases
          - mcp-toggle-modal
          - mcp-toggle-persistence
          - mcp-toggle-session-sync
          - thinking-level-selector
          - tools-modal-complete
          - worktree-isolation

    steps:
      - name: Check if test should run
        id: check
        run: |
          if [ -n "$SELECTED_TEST" ] && [ "$SELECTED_TEST" != "${{ matrix.test }}" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping test ${{ matrix.test }} (only running $SELECTED_TEST)"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.check.outputs.should_run == 'true'

      - name: Setup Node
        uses: actions/setup-node@v4
        if: steps.check.outputs.should_run == 'true'
        with:
          node-version: '22'

      - name: Setup Bun
        uses: ./.github/actions/setup-bun
        if: steps.check.outputs.should_run == 'true'
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Starting bun install at $(date)"
          timeout 180 bun install --verbose 2>&1 || {
            echo "bun install timed out or failed"
            exit 1
          }
          echo "Finished bun install at $(date)"

      - name: Build web package
        if: steps.check.outputs.should_run == 'true'
        working-directory: packages/web
        run: |
          echo "Building web package..."
          bun run build

      - name: Install Playwright browsers
        if: steps.check.outputs.should_run == 'true'
        run: |
          # Install for both packages since e2e-runner.ts spawns Playwright from packages/e2e
          cd packages/cli && bunx playwright install chromium
          cd ../e2e && bunx playwright install chromium

      - name: Run E2E test with in-process server (${{ matrix.test }})
        if: steps.check.outputs.should_run == 'true'
        working-directory: packages/cli
        run: |
          echo "Running test: ${{ matrix.test }} with in-process server"
          # Run with bun --coverage to instrument daemon/shared code
          # e2e-runner.ts starts in-process server and spawns Playwright test
          timeout 300 xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
            bun --coverage --coverage-reporter=lcov --coverage-dir=coverage \
            ./tests/e2e-coverage/e2e-runner.ts ${{ matrix.test }} 2>&1
        env:
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          DEFAULT_MODEL: haiku
          CI: true
          COVERAGE: true

      - name: Upload browser coverage artifact
        uses: actions/upload-artifact@v4
        if: steps.check.outputs.should_run == 'true' && always()
        with:
          name: coverage-e2e-browser-${{ matrix.test }}
          path: packages/e2e/coverage/lcov.info
          retention-days: 1
          if-no-files-found: ignore

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure() && steps.check.outputs.should_run == 'true'
        with:
          name: e2e-results-${{ matrix.test }}
          path: |
            packages/e2e/test-results/
            packages/e2e/playwright-report/
          retention-days: 7

  # ============================================
  # UPLOAD COVERAGE (Single upload after all tests)
  # Runs after all E2E matrix jobs complete
  # Merges coverage files and uploads once to Codecov
  # ============================================

  upload-coverage:
    name: Upload Coverage
    runs-on: arc-runner-set
    needs: e2e
    if: always()
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Download all browser coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-e2e-browser-*
          path: coverage-browser
          merge-multiple: false

      - name: List downloaded coverage files
        run: |
          echo "Browser coverage files:"
          find coverage-browser -name "*.info" -type f 2>/dev/null || echo "No browser coverage files found"

      - name: Merge browser coverage files
        run: |
          mkdir -p merged-coverage

          # Merge browser coverage
          FIRST=true
          for f in $(find coverage-browser -name "lcov.info" -type f 2>/dev/null); do
            echo "Adding browser coverage from: $f"
            if [ "$FIRST" = true ]; then
              cp "$f" merged-coverage/browser-lcov.info
              FIRST=false
            else
              cat "$f" >> merged-coverage/browser-lcov.info
            fi
          done

          if [ -f merged-coverage/browser-lcov.info ]; then
            echo "Merged browser coverage file created"
            wc -l merged-coverage/browser-lcov.info
          else
            echo "No browser coverage files to merge"
          fi

      - name: Upload merged coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: merged-coverage/browser-lcov.info
          flags: e2e-matrix
          fail_ci_if_error: false
