name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  e2e:
    name: E2E (${{ matrix.test }})
    runs-on: self-hosted
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        test:
          - 2-stage-creation
          - auto-scroll-toggle
          - auto-title-generation
          - character-counter
          - chat-flow-improved
          - chat-flow
          - connection-overlay
          - connection-state
          - context-dropdown
          - context-usage-dropdown
          - draft-clearing-bug
          - draft-persistence
          - error-handling
          - file-attachment
          - file-operations
          - home
          - interrupt-button
          - interruption-error
          - mcp-toggle
          - message-input-ux
          - message-pagination
          - message-removal
          - message-send-receive
          - mobile-responsive
          - model-switcher
          - multi-session-concurrent
          - page-refresh
          - processing-state
          - recent-sessions-home
          - reconnection-message-sync
          - scroll-responsiveness
          - scroll-to-bottom-button
          - session-archive
          - session-export
          - session-list-ordering
          - session-management
          - session-status-indicators
          - session-switching-comprehensive
          - settings-modal
          - slash-command-autocomplete
          - thinking-level-selector
          - tools-modal-complete
          - ui-components
          - worktree-isolation

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: ./.github/actions/setup-bun
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(cat packages/e2e/package.json | jq -r '.dependencies["@playwright/test"] // .devDependencies["@playwright/test"]')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: packages/e2e
        run: bunx playwright install --with-deps chromium

      - name: Install Playwright dependencies (cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: bunx playwright install-deps chromium

      - name: Run E2E test (${{ matrix.test }})
        working-directory: packages/e2e
        run: bun run test tests/${{ matrix.test }}.e2e.ts
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-results-${{ matrix.test }}
          path: |
            packages/e2e/test-results/
            packages/e2e/playwright-report/
          retention-days: 7
