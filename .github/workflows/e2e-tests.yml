name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  e2e:
    name: E2E (${{ matrix.test }})
    runs-on: self-hosted
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        test:
          - home
          # Temporarily disabled for CI debugging:
          # - 2-stage-creation
          # - auto-scroll-toggle
          # - auto-title-generation
          # - character-counter
          # - chat-flow-improved
          # - chat-flow
          # - connection-overlay
          # - connection-state
          # - context-dropdown
          # - context-usage-dropdown
          # - draft-clearing-bug
          # - draft-persistence
          # - error-handling
          # - file-attachment
          # - file-operations
          # - interrupt-button
          # - interruption-error
          # - mcp-toggle
          # - message-input-ux
          # - message-pagination
          # - message-removal
          # - message-send-receive
          # - mobile-responsive
          # - model-switcher
          # - multi-session-concurrent
          # - page-refresh
          # - processing-state
          # - recent-sessions-home
          # - reconnection-message-sync
          # - scroll-responsiveness
          # - scroll-to-bottom-button
          # - session-archive
          # - session-export
          # - session-list-ordering
          # - session-management
          # - session-status-indicators
          # - session-switching-comprehensive
          # - settings-modal
          # - slash-command-autocomplete
          # - thinking-level-selector
          # - tools-modal-complete
          # - ui-components
          # - worktree-isolation

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: ./.github/actions/setup-bun
        with:
          bun-version: 1.3.5

      - name: Debug before install
        run: |
          echo "Working directory: $(pwd)"
          echo "Bun version: $(bun --version)"
          echo "Node modules exists: $(ls -la node_modules 2>/dev/null | head -5 || echo 'no')"
          echo "Disk space:"
          df -h | head -3

      - name: Install dependencies
        run: |
          echo "Starting bun install at $(date)"
          timeout 180 bun install --verbose 2>&1 || {
            echo "bun install timed out or failed"
            exit 1
          }
          echo "Finished bun install at $(date)"

      - name: Install Playwright system dependencies
        working-directory: packages/e2e
        run: |
          # System deps must be installed every time (ephemeral containers)
          # This is fast since it just runs apt-get for missing packages
          sudo bunx playwright install-deps chromium

      - name: Install Playwright Browsers
        working-directory: packages/e2e
        env:
          PLAYWRIGHT_BROWSERS_PATH: /home/runner/_work/_tool/e2e_tools
        run: |
          # Use shared tool cache for browsers across all self-hosted runners
          # Once one runner installs, all runners can reuse the same browsers
          mkdir -p $PLAYWRIGHT_BROWSERS_PATH
          bunx playwright install chromium
          echo "Installed browsers:"
          ls -la $PLAYWRIGHT_BROWSERS_PATH || true

      - name: Debug environment
        run: |
          echo "PLAYWRIGHT_BROWSERS_PATH: $PLAYWRIGHT_BROWSERS_PATH"
          echo "Checking chromium executable..."
          find /home/runner/_work/_tool/e2e_tools -name "chrome" -o -name "chromium" 2>/dev/null | head -5 || true
          echo "Checking libxkbcommon (was missing before)..."
          ldconfig -p | grep xkbcommon || echo "libxkbcommon not in ldconfig"
          echo "Checking Chrome can find its libs..."
          ldd /home/runner/_work/_tool/e2e_tools/chromium-*/chrome-linux64/chrome 2>&1 | grep "not found" || echo "All libs found!"
        env:
          PLAYWRIGHT_BROWSERS_PATH: /home/runner/_work/_tool/e2e_tools

      - name: Start dev server
        working-directory: packages/cli
        run: |
          echo "Starting dev server..."
          NODE_ENV=test nohup bun run dev > /tmp/server.log 2>&1 &
          echo "Server PID: $!"
          echo "Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:9283 > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          if ! curl -s http://localhost:9283 > /dev/null 2>&1; then
            echo "Server failed to start!"
            echo "=== Server logs ==="
            cat /tmp/server.log
            exit 1
          fi
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Verify Playwright can launch browser
        working-directory: packages/e2e
        run: |
          echo "Testing if Playwright can find chromium..."
          ls -la $PLAYWRIGHT_BROWSERS_PATH/chromium-*/chrome-linux64/ || echo "Chrome not found"
          echo ""
          echo "Testing browser launch..."
          timeout 30 node -e "
            const { chromium } = require('@playwright/test');
            (async () => {
              console.log('Launching browser...');
              const browser = await chromium.launch({ headless: true });
              console.log('Browser launched successfully');
              await browser.close();
              console.log('Browser closed');
            })().catch(e => { console.error('Failed:', e.message); process.exit(1); });
          " 2>&1 || echo "Failed to launch browser"
        env:
          PLAYWRIGHT_BROWSERS_PATH: /home/runner/_work/_tool/e2e_tools
          CI: true

      - name: Test playwright --list
        working-directory: packages/e2e
        run: |
          echo "Listing tests..."
          timeout 30 bunx playwright test --list --project=read-only 2>&1 | head -20 || echo "List failed"
        env:
          PLAYWRIGHT_BROWSERS_PATH: /home/runner/_work/_tool/e2e_tools
          CI: true
          PW_TEST_REUSE_CONTEXT: 1

      - name: Run E2E test (${{ matrix.test }})
        working-directory: packages/e2e
        run: |
          echo "Running test: tests/${{ matrix.test }}.e2e.ts"
          # Use xvfb-run to provide virtual display
          timeout 180 xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
            bun run test tests/${{ matrix.test }}.e2e.ts --reporter=list 2>&1
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          PLAYWRIGHT_BROWSERS_PATH: /home/runner/_work/_tool/e2e_tools
          CI: true
          PW_TEST_REUSE_CONTEXT: 1

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-results-${{ matrix.test }}
          path: |
            packages/e2e/test-results/
            packages/e2e/playwright-report/
          retention-days: 7
