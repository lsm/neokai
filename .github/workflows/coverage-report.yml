name: Coverage Report

on:
  # Trigger after test workflows complete
  workflow_run:
    workflows: ["Offline Tests", "Daemon Online Tests"]
    types: [completed]
    branches: [main, develop]
  # Allow manual trigger (useful after E2E tests)
  workflow_dispatch:
    inputs:
      include_e2e:
        description: 'Include E2E coverage if available'
        required: false
        type: boolean
        default: false

jobs:
  merge-coverage:
    name: Merge Coverage Reports
    runs-on: arc-runner-set
    # Only run if the triggering workflow succeeded, or if manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Download coverage from Offline Tests
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: offline-tests.yml
          branch: ${{ github.event.workflow_run.head_branch || github.ref_name }}
          name: coverage-.*
          name_is_regexp: true
          path: coverage-parts/offline
          if_no_artifact_found: warn
          search_artifacts: true

      - name: Download coverage from Online Tests
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: daemon-online-tests.yml
          branch: ${{ github.event.workflow_run.head_branch || github.ref_name }}
          name: coverage-.*
          name_is_regexp: true
          path: coverage-parts/online
          if_no_artifact_found: warn
          search_artifacts: true

      - name: Download coverage from E2E Tests (optional)
        if: ${{ github.event.inputs.include_e2e == 'true' }}
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: e2e-tests.yml
          branch: ${{ github.event.workflow_run.head_branch || github.ref_name }}
          name: coverage-.*
          name_is_regexp: true
          path: coverage-parts/e2e
          if_no_artifact_found: ignore
          search_artifacts: true

      - name: List downloaded coverage files
        run: |
          echo "=== Coverage files found ==="
          find coverage-parts -name "*.info" -o -name "lcov.info" 2>/dev/null || echo "No coverage files found"
          echo ""
          echo "=== Directory structure ==="
          find coverage-parts -type f 2>/dev/null | head -50 || echo "No files found"

      - name: Check minimum coverage files
        id: check-coverage
        run: |
          # Count lcov.info files
          COUNT=$(find coverage-parts -name "lcov.info" -type f 2>/dev/null | wc -l | tr -d ' ')
          echo "Found $COUNT coverage files"

          if [ "$COUNT" -lt 1 ]; then
            echo "No coverage files found, skipping merge"
            echo "should_merge=false" >> $GITHUB_OUTPUT
          else
            echo "Proceeding with merge"
            echo "should_merge=true" >> $GITHUB_OUTPUT
            echo "file_count=$COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Install lcov
        if: steps.check-coverage.outputs.should_merge == 'true'
        run: |
          if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y lcov
          elif command -v apk &> /dev/null; then
            apk add --no-cache lcov
          else
            echo "Package manager not found, trying to continue..."
          fi

      - name: Merge coverage reports
        if: steps.check-coverage.outputs.should_merge == 'true'
        run: |
          mkdir -p coverage

          # Find all lcov.info files
          LCOV_FILES=$(find coverage-parts -name "lcov.info" -type f)

          # Build lcov merge command
          MERGE_ARGS=""
          for f in $LCOV_FILES; do
            echo "Adding: $f"
            MERGE_ARGS="$MERGE_ARGS -a $f"
          done

          # Merge all coverage files
          echo "Merging ${{ steps.check-coverage.outputs.file_count }} coverage files..."
          lcov $MERGE_ARGS -o coverage/merged.lcov --ignore-errors empty,unused

          # Print summary
          echo ""
          echo "=== Coverage Summary ==="
          lcov --summary coverage/merged.lcov 2>&1 || true

      - name: Generate HTML report
        if: steps.check-coverage.outputs.should_merge == 'true'
        run: |
          genhtml coverage/merged.lcov -o coverage/html --ignore-errors source,empty || echo "HTML generation failed, continuing..."

      - name: Upload merged coverage artifact
        if: steps.check-coverage.outputs.should_merge == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-merged-${{ github.run_number }}
          path: |
            coverage/merged.lcov
            coverage/html/
          retention-days: 30

      - name: Upload to Codecov
        if: steps.check-coverage.outputs.should_merge == 'true'
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/merged.lcov
          flags: merged
          name: coverage-merged
          fail_ci_if_error: false
          verbose: true

      - name: Create coverage badge data
        if: steps.check-coverage.outputs.should_merge == 'true'
        run: |
          # Extract total line coverage percentage
          COVERAGE=$(lcov --summary coverage/merged.lcov 2>&1 | grep "lines" | grep -oP '\d+\.\d+' | head -1 || echo "0")
          echo "Total line coverage: ${COVERAGE}%"

          # Create badge JSON for shields.io
          mkdir -p coverage/badge
          cat > coverage/badge/coverage.json << EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${COVERAGE}%",
            "color": "$(if [ $(echo "$COVERAGE > 80" | bc -l) -eq 1 ]; then echo "brightgreen"; elif [ $(echo "$COVERAGE > 60" | bc -l) -eq 1 ]; then echo "yellow"; else echo "red"; fi)"
          }
          EOF

          cat coverage/badge/coverage.json

      - name: Summary
        if: always()
        run: |
          echo "## Coverage Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-coverage.outputs.should_merge }}" == "true" ]; then
            echo "- **Files merged:** ${{ steps.check-coverage.outputs.file_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifact:** coverage-merged-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ -f coverage/merged.lcov ]; then
              echo "### Coverage Summary" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              lcov --summary coverage/merged.lcov 2>&1 >> $GITHUB_STEP_SUMMARY || echo "Could not generate summary"
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Status:** No coverage files found to merge" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          fi
