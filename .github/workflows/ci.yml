name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  check:
    name: Lint, Knip, Format & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Run linter
        id: lint
        run: bun run lint
        continue-on-error: true

      - name: Check formatting
        id: format
        run: bun run format:check
        continue-on-error: true

      - name: Run Knip
        id: knip
        run: bun run knip
        continue-on-error: true

      - name: Run type check
        id: typecheck
        run: bun run typecheck
        continue-on-error: true

      - name: Check for failures
        if: steps.lint.outcome == 'failure' || steps.format.outcome == 'failure' || steps.knip.outcome == 'failure' || steps.typecheck.outcome == 'failure'
        run: |
          echo "❌ One or more checks failed:"
          echo "  Lint: ${{ steps.lint.outcome }}"
          echo "  Format: ${{ steps.format.outcome }}"
          echo "  Knip: ${{ steps.knip.outcome }}"
          echo "  Typecheck: ${{ steps.typecheck.outcome }}"
          exit 1

  test-daemon-offline:
    name: Daemon Offline Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Run daemon unit tests
        working-directory: packages/daemon
        run: bun run test:unit
        env:
          GLM_API_KEY: ""
          CLAUDE_CODE_OAUTH_TOKEN: ""

      - name: Run daemon integration tests
        working-directory: packages/daemon
        run: bun run test:integration
        env:
          GLM_API_KEY: ""
          CLAUDE_CODE_OAUTH_TOKEN: ""

  test-web:
    name: Web Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Run web tests
        working-directory: packages/web
        run: bunx vitest run

  test-cli:
    name: CLI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Run CLI tests
        working-directory: packages/cli
        run: bun test

  all-tests-pass:
    name: All Tests Pass
    runs-on: ubuntu-latest
    timeout-minutes: 1
    if: always()
    needs:
      - check
      - test-daemon-offline
      - test-web
      - test-cli

    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.check.result }}" != "success" ]] || \
             [[ "${{ needs.test-daemon-offline.result }}" != "success" ]] || \
             [[ "${{ needs.test-web.result }}" != "success" ]] || \
             [[ "${{ needs.test-cli.result }}" != "success" ]]; then
            echo "❌ One or more jobs failed:"
            echo "  check: ${{ needs.check.result }}"
            echo "  test-daemon-offline: ${{ needs.test-daemon-offline.result }}"
            echo "  test-web: ${{ needs.test-web.result }}"
            echo "  test-cli: ${{ needs.test-cli.result }}"
            exit 1
          fi
          echo "✅ All tests passed!"
